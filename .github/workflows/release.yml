name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  DOTNET_VERSION: '6.0.x'
  
jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name:  Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name:  Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name:  Get Version
      id: get_version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $version = "${{ github.ref_name }}".TrimStart('v')
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    - name:  Restore Dependencies
      run: dotnet restore WinShell.sln
    
    - name:  Build Solution
      run: dotnet build WinShell.sln --configuration Release --no-restore
    
    - name:  Create NuGet Package
      run: |
        dotnet pack winshell.cli\WinShell.CLI.csproj `
          --configuration Release `
          --no-build `
          --output ./packages `
          /p:Version=${{ steps.get_version.outputs.VERSION }}
    
    - name:  Publish CLI
      run: |
        dotnet publish winshell.cli\WinShell.CLI.csproj `
          --configuration Release `
          --output ./publish/cli `
          --runtime win-x64 `
          --self-contained false
    
    - name:  Publish GUI
      run: |
        dotnet publish winshell.gui\WinShell.GUI.csproj `
          --configuration Release `
          --output ./publish/gui `
          --runtime win-x64 `
          --self-contained false
    
    - name:  Create Release Packages
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        
        New-Item -ItemType Directory -Path ./releases -Force
        
        Compress-Archive -Path ./publish/cli/* `
          -DestinationPath "./releases/WinShell-CLI-v$version-win-x64.zip"
        
        Compress-Archive -Path ./publish/gui/* `
          -DestinationPath "./releases/WinShell-GUI-v$version-win-x64.zip"
        
        New-Item -ItemType Directory -Path ./publish/combined/CLI -Force
        New-Item -ItemType Directory -Path ./publish/combined/GUI -Force
        Copy-Item ./publish/cli/* ./publish/combined/CLI/ -Recurse -Force
        Copy-Item ./publish/gui/* ./publish/combined/GUI/ -Recurse -Force
        Copy-Item README.md ./publish/combined/ -ErrorAction SilentlyContinue
        Copy-Item LICENSE ./publish/combined/ -ErrorAction SilentlyContinue
        
        Compress-Archive -Path ./publish/combined/* `
          -DestinationPath "./releases/WinShell-Complete-v$version-win-x64.zip"
        
        Get-ChildItem ./releases/*.zip | ForEach-Object {
          $hash = (Get-FileHash -Path $_.FullName -Algorithm SHA256).Hash
          "$hash  $($_.Name)" | Out-File -FilePath ./releases/checksums.txt -Append -Encoding UTF8
        }
    
    - name:  Generate Release Notes
      id: release_notes
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $notes = @"
        ##  WinShell v$version
        
        ###  Installation Methods
        
        #### Method 1: .NET Global Tool (Recommended)
        `ash
        dotnet tool install --global WinShell.CLI --version $version
        `
        
        #### Method 2: Download Binaries
        Download one of the ZIP files below:
        - **WinShell-CLI** - Command-line interface only
        - **WinShell-GUI** - Graphical interface only
        - **WinShell-Complete** - Both CLI and GUI
        
        ###  Features
        - 30+ built-in commands
        - Native pipeline support (|)
        - Background job management (&, jobs, fg, bg)
        - I/O redirection (>, >>, <)
        - Async command execution
        - Ctrl+C cancellation support
        - 6 beautiful themes (GUI)
        - Real-time process monitoring
        - Command history
        
        ###  Requirements
        - Windows 10 version 1809 or later
        - .NET 6.0 Runtime (for framework-dependent builds)
        
        ###  Verification
        See `checksums.txt` for SHA256 hashes of all release files.
        
        ###  Documentation
        - [User Guide](https://github.com/23f2003700/WinShell/blob/main/README.md)
        
        ###  Bug Reports
        Report issues at: https://github.com/23f2003700/WinShell/issues
        "@
        
        $notes | Out-File -FilePath ./release_notes.md -Encoding UTF8
    
    - name:  Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        name: WinShell v${{ steps.get_version.outputs.VERSION }}
        body_path: ./release_notes.md
        draft: false
        prerelease: false
        files: |
          ./releases/*.zip
          ./releases/checksums.txt
          ./packages/*.nupkg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name:  Publish to NuGet
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      run: |
        dotnet nuget push ./packages/*.nupkg `
          --api-key ${{ secrets.NUGET_API_KEY }} `
          --source https://api.nuget.org/v3/index.json `
          --skip-duplicate
    
    - name:  Build Summary
      shell: pwsh
      run: |
        Write-Host " Build completed successfully!" -ForegroundColor Green
        Write-Host ""
        Write-Host "Version: ${{ steps.get_version.outputs.VERSION }}" -ForegroundColor Cyan
        Write-Host "Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.VERSION }}" -ForegroundColor Cyan
