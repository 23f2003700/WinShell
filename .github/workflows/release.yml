name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  DOTNET_VERSION: '6.0.x'
  
jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    # ========================================================================
    # Checkout Code
    # ========================================================================
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for proper versioning
    
    # ========================================================================
    # Setup .NET
    # ========================================================================
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    # ========================================================================
    # Get Version from Tag
    # ========================================================================
    - name: ðŸ·ï¸ Get Version
      id: get_version
      shell: pwsh
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $version = "${{ github.event.inputs.version }}"
        } else {
          $version = "${{ github.ref_name }}".TrimStart('v')
        }
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
    
    # ========================================================================
    # Restore Dependencies
    # ========================================================================
    - name: ðŸ“¦ Restore Dependencies
      run: dotnet restore WinShell.sln
    
    # ========================================================================
    # Build Solution
    # ========================================================================
    - name: ðŸ”¨ Build Solution
      run: dotnet build WinShell.sln --configuration Release --no-restore
    
    # ========================================================================
    # Create NuGet Package
    # ========================================================================
    - name: ðŸ“¦ Create NuGet Package
      run: |
        dotnet pack winshell.cli\WinShell.CLI.csproj `
          --configuration Release `
          --no-build `
          --output ./packages `
          /p:Version=${{ steps.get_version.outputs.VERSION }}
    
    # ========================================================================
    # Publish CLI
    # ========================================================================
    - name: ðŸš€ Publish CLI
      run: |
        dotnet publish winshell.cli\WinShell.CLI.csproj `
          --configuration Release `
          --output ./publish/cli `
          --runtime win-x64 `
          --no-self-contained
    
    # ========================================================================
    # Publish GUI
    # ========================================================================
    - name: ðŸš€ Publish GUI
      run: |
        dotnet publish winshell.gui\WinShell.GUI.csproj `
          --configuration Release `
          --output ./publish/gui `
          --runtime win-x64 `
          --no-self-contained
    
    # ========================================================================
    # Create ZIP Packages
    # ========================================================================
    - name: ðŸ“¦ Create Release Packages
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        
        # Create release directory
        New-Item -ItemType Directory -Path ./releases -Force
        
        # CLI ZIP
        Compress-Archive -Path ./publish/cli/* `
          -DestinationPath "./releases/WinShell-CLI-v$version-win-x64.zip"
        
        # GUI ZIP
        Compress-Archive -Path ./publish/gui/* `
          -DestinationPath "./releases/WinShell-GUI-v$version-win-x64.zip"
        
        # Combined ZIP
        New-Item -ItemType Directory -Path ./publish/combined/CLI -Force
        New-Item -ItemType Directory -Path ./publish/combined/GUI -Force
        Copy-Item ./publish/cli/* ./publish/combined/CLI/ -Recurse -Force
        Copy-Item ./publish/gui/* ./publish/combined/GUI/ -Recurse -Force
        Copy-Item README.md ./publish/combined/ -ErrorAction SilentlyContinue
        Copy-Item LICENSE ./publish/combined/ -ErrorAction SilentlyContinue
        
        Compress-Archive -Path ./publish/combined/* `
          -DestinationPath "./releases/WinShell-Complete-v$version-win-x64.zip"
        
        # Generate checksums
        Get-ChildItem ./releases/*.zip | ForEach-Object {
          $hash = (Get-FileHash -Path $_.FullName -Algorithm SHA256).Hash
          "$hash  $($_.Name)" | Out-File -FilePath ./releases/checksums.txt -Append -Encoding UTF8
        }
    
    # ========================================================================
    # Generate Release Notes
    # ========================================================================
    - name: ðŸ“ Generate Release Notes
      id: release_notes
      shell: pwsh
      run: |
        $version = "${{ steps.get_version.outputs.VERSION }}"
        $notes = @"
        ## ðŸŽ‰ WinShell v$version
        
        ### ðŸ“¦ Installation Methods
        
        #### Method 1: .NET Global Tool (Recommended)
        ``````bash
        dotnet tool install --global WinShell.CLI --version $version
        ``````
        
        #### Method 2: Download Binaries
        Download one of the ZIP files below:
        - **WinShell-CLI** - Command-line interface only
        - **WinShell-GUI** - Graphical interface only
        - **WinShell-Complete** - Both CLI and GUI
        
        ### âœ¨ Features
        - 30+ built-in commands
        - Native pipeline support (|)
        - Background job management (&, jobs, fg, bg)
        - I/O redirection (>, >>, <)
        - Async command execution
        - Ctrl+C cancellation support
        - 6 beautiful themes (GUI)
        - Real-time process monitoring
        - Command history
        
        ### ðŸ“‹ Requirements
        - Windows 10 version 1809 or later
        - .NET 6.0 Runtime (for framework-dependent builds)
        
        ### ðŸ”’ Verification
        See \`checksums.txt\` for SHA256 hashes of all release files.
        
        ### ðŸ“š Documentation
        - [Installation Guide](https://github.com/23f2003700/WinShell/blob/main/INSTALLATION.md)
        - [User Guide](https://github.com/23f2003700/WinShell/blob/main/README.md)
        
        ### ðŸ› Bug Reports
        Report issues at: https://github.com/23f2003700/WinShell/issues
        "@
        
        $notes | Out-File -FilePath ./release_notes.md -Encoding UTF8
    
    # ========================================================================
    # Create GitHub Release
    # ========================================================================
    - name: ðŸŽ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.VERSION }}
        name: WinShell v${{ steps.get_version.outputs.VERSION }}
        body_path: ./release_notes.md
        draft: false
        prerelease: false
        files: |
          ./releases/*.zip
          ./releases/checksums.txt
          ./packages/*.nupkg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # ========================================================================
    # Publish to NuGet (Optional - uncomment if you want auto-publish)
    # ========================================================================
    # - name: ðŸ“¤ Publish to NuGet
    #   if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    #   run: |
    #     dotnet nuget push ./packages/*.nupkg `
    #       --api-key ${{ secrets.NUGET_API_KEY }} `
    #       --source https://api.nuget.org/v3/index.json `
    #       --skip-duplicate
    
    # ========================================================================
    # Summary
    # ========================================================================
    - name: ðŸ“Š Build Summary
      shell: pwsh
      run: |
        Write-Host "âœ… Build completed successfully!" -ForegroundColor Green
        Write-Host ""
        Write-Host "Version: ${{ steps.get_version.outputs.VERSION }}" -ForegroundColor Cyan
        Write-Host "Release URL: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.VERSION }}" -ForegroundColor Cyan
